<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Capengine</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #212529;
            --text-secondary: #6c757d;
            --accent-color: #8a2be2;
            --header-bg: #4CAF50;
            --block-bg: #FF9800;
            --block-var: #9C27B0;
            --block-control: #F44336;
            --block-loop: #3F51B5;
            --block-func: #009688;
            --block-io: #607D8B;
            --block-data: #795548;
            --block-other: #00BCD4;
            --connector-color: #4CAF50;
            --output-bg: #333;
            --output-text: #0f0;
            --chat-bg: #f1f3f5;
            --chat-msg-bg: #e9ecef;
            --chat-user-msg-bg: #d8f8d8;
        }

        [data-theme="dark"] {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e6e6e6;
            --text-secondary: #adb5bd;
            --accent-color: #9b51e0;
            --header-bg: #2e7d32;
            --block-bg: #f57c00;
            --block-var: #7b1fa2;
            --block-control: #d32f2f;
            --block-loop: #303f9f;
            --block-func: #00796b;
            --block-io: #455a64;
            --block-data: #5d4037;
            --block-other: #0097a7;
            --connector-color: #388e3c;
            --output-bg: #1e1e1e;
            --output-text: #4caf50;
            --chat-bg: #2a2d31;
            --chat-msg-bg: #383c43;
            --chat-user-msg-bg: #2c4a3a;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .header {
            background: var(--header-bg);
            color: white;
            padding: 15px;
            text-align: center;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-nav a {
            color: white;
            text-decoration: none;
            margin: 0 10px;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.3s;
        }

        .header-nav a:hover {
            background: rgba(255,255,255,0.2);
        }

        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
        }

        .container {
            display: flex;
            padding: 20px;
            gap: 20px;
        }

        .blocks-panel {
            width: 300px;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 5px;
            overflow-y: auto;
            height: 80vh;
        }

        .block-category {
            margin-bottom: 15px;
        }

        .block-category h3 {
            margin-top: 0;
            color: var(--text-primary);
            border-bottom: 1px solid var(--text-secondary);
            padding-bottom: 5px;
        }

        .block {
            color: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: grab;
            position: relative;
        }

        .block.basic { background: var(--block-bg); }
        .block.var { background: var(--block-var); }
        .block.control { background: var(--block-control); }
        .block.loop { background: var(--block-loop); }
        .block.func { background: var(--block-func); }
        .block.io { background: var(--block-io); }
        .block.data { background: var(--block-data); }
        .block.other { background: var(--block-other); }
        
        .workspace {
            flex-grow: 1;
            min-height: 80vh;
            background: var(--bg-secondary);
            border-radius: 5px;
            position: relative;
            overflow: hidden;
        }

        .connector {
            width: 15px;
            height: 15px;
            background: var(--connector-color);
            border-radius: 50%;
            position: absolute;
            bottom: -7px;
            left: 50%;
            transform: translateX(-50%);
            cursor: pointer;
            z-index: 10;
        }

        .top-connector {
            top: -7px;
            bottom: auto;
        }

        .connection-line {
            position: absolute;
            background: var(--connector-color);
            height: 2px;
            transform-origin: left center;
            z-index: 5;
            pointer-events: none;
        }

        .controls {
            padding: 15px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--text-secondary);
        }

        #run-btn {
            background: var(--header-bg);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }

        #clear-btn {
            background: var(--block-control);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
        }

        #output {
            background: var(--output-bg);
            color: var(--output-text);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-family: monospace;
            white-space: pre-wrap;
            max-height: 200px;
            overflow-y: auto;
        }

        .block-input {
            background: rgba(255,255,255,0.3);
            border: none;
            color: white;
            padding: 2px 5px;
            margin: 0 3px;
            width: 60px;
        }

        .input-type-toggle {
            display: flex;
            align-items: center;
            margin: 5px 0;
            font-size: 12px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
            margin: 0 10px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 2px;
            bottom: 2px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .chat-container {
            width: 300px;
            background: var(--bg-secondary);
            border-radius: 5px;
            display: flex;
            flex-direction: column;
            height: 80vh;
        }

        .chat-header {
            padding: 15px;
            background: var(--accent-color);
            color: white;
            border-radius: 5px 5px 0 0;
            text-align: center;
        }

        .chat-messages {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            background: var(--chat-bg);
        }

        .chat-message {
            margin-bottom: 10px;
            padding: 8px 12px;
            border-radius: 12px;
            background: var(--chat-msg-bg);
            max-width: 80%;
        }

        .chat-message.user {
            background: var(--chat-user-msg-bg);
            margin-left: auto;
        }

        .chat-input-container {
            display: flex;
            padding: 10px;
            border-top: 1px solid var(--text-secondary);
            background: var(--bg-secondary);
        }

        #chat-input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--text-secondary);
            border-radius: 4px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        #chat-send {
            background: var(--accent-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .support-page {
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
        }

        .support-links {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-top: 30px;
        }

        .support-link {
            display: block;
            padding: 20px;
            background: var(--bg-secondary);
            border-radius: 8px;
            text-decoration: none;
            color: var(--text-primary);
            text-align: center;
            transition: transform 0.2s;
        }

        .support-link:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>Capengine</h1>
        <div class="header-nav">
            <a href="#" onclick="showPage('main')">Главная</a>
            <a href="#" onclick="showPage('support')">Поддержка</a>
        </div>
        <button class="theme-toggle" id="theme-toggle">🌙 Тёмная</button>
    </div>

    <div id="main-page">
        <div class="container">
            <div class="blocks-panel">
                <div class="block-category">
                    <h3>Переменные</h3>
                    <div class="block var" data-type="var_decl">var <input class="block-input" value="x"> = <input class="block-input" value="0"></div>
                    <div class="block var" data-type="var_assign"><input class="block-input" value="x"> = <input class="block-input" value="0"></div>
                </div>

                <div class="block-category">
                    <h3>Управление</h3>
                    <div class="block control" data-type="if">if <input class="block-input" value="condition">:</div>
                    <div class="block control" data-type="elif">elif <input class="block-input" value="condition">:</div>
                    <div class="block control" data-type="else">else:</div>
                </div>

                <div class="block-category">
                    <h3>Циклы</h3>
                    <div class="block loop" data-type="for">for <input class="block-input" value="i"> in range(<input class="block-input" value="5">):</div>
                    <div class="block loop" data-type="while">while <input class="block-input" value="condition">:</div>
                    <div class="block loop" data-type="break">break</div>
                    <div class="block loop" data-type="continue">continue</div>
                </div>

                <div class="block-category">
                    <h3>Функции</h3>
                    <div class="block func" data-type="def">def <input class="block-input" value="func_name">():</div>
                    <div class="block func" data-type="return">return <input class="block-input" value="value"></div>
                    <div class="block func" data-type="lambda">lambda <input class="block-input" value="x">: <input class="block-input" value="x+1"></div>
                </div>

                <div class="block-category">
                    <h3>Ввод/Вывод</h3>
                    <div class="block io" data-type="print">print(<input class="block-input" value="text">)</div>
                    <div class="block io" data-type="input">
                        <input class="block-input" value="var"> = input(<input class="block-input" value="prompt">)
                        <div class="input-type-toggle">
                            <span>Текст</span>
                            <label class="toggle-switch">
                                <input type="checkbox" class="input-type-checkbox">
                                <span class="slider"></span>
                            </label>
                            <span>Переменная</span>
                        </div>
                    </div>
                </div>

                <div class="block-category">
                    <h3>Данные</h3>
                    <div class="block data" data-type="list">[<input class="block-input" value="1,2,3">]</div>
                    <div class="block data" data-type="dict">{<input class="block-input" value="key:value">}</div>
                    <div class="block data" data-type="tuple">(<input class="block-input" value="1,2">)</div>
                </div>

                <div class="block-category">
                    <h3>Другое</h3>
                    <div class="block other" data-type="import">import <input class="block-input" value="module"></div>
                    <div class="block other" data-type="try">try:</div>
                    <div class="block other" data-type="except">except <input class="block-input" value="Exception">:</div>
                    <div class="block other" data-type="finally">finally:</div>
                    <div class="block other" data-type="with">with <input class="block-input" value="resource"> as <input class="block-input" value="alias">:</div>
                </div>
            </div>

            <div id="workspace" class="workspace"></div>

            <div class="chat-container">
                <div class="chat-header">
                    <h3>Чат с сообществом</h3>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message">Добро пожаловать в чат! Напишите сообщение...</div>
                </div>
                <div class="chat-input-container">
                    <input type="text" id="chat-input" placeholder="Введите сообщение...">
                    <button id="chat-send">➤</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <button id="run-btn">▶ Запустить</button>
            <button id="clear-btn">❌ Очистить</button>
            <div id="output">> Начните создавать программу...</div>
        </div>
    </div>

    <div id="support-page" class="support-page" style="display: none;">
        <h2>Поддержка разработки</h2>
        <p>Ваша поддержка помогает развивать проект и добавлять новые функции!</p>
        
        <div class="support-links">
            <a href="https://www.donationalerts.com/r/capengine" class="support-link" target="_blank">
                <h3>💰 Финансовая поддержка</h3>
                <p>DonationAlerts - поддержка идей проекта</p>
            </a>
            
            <a href="https://t.me/capengine" class="support-link" target="_blank">
                <h3>💬 Telegram-чат</h3>
                <p>Присоединяйтесь к нашему сообществу</p>
            </a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <script>
        let pyodide;
        let draggedBlock = null;
        let connections = [];
        let nextBlockId = 1;
        let draggingConnection = null;
        let tempLine = null;
        let currentTheme = 'light';

        function showPage(page) {
            if (page === 'main') {
                document.getElementById('main-page').style.display = 'block';
                document.getElementById('support-page').style.display = 'none';
            } else if (page === 'support') {
                document.getElementById('main-page').style.display = 'none';
                document.getElementById('support-page').style.display = 'block';
            }
        }

        async function initPyodide() {
            pyodide = await loadPyodide({
                indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"
            });
            document.getElementById('output').textContent = "> Python готов к работе!";
        }
        initPyodide();

        document.querySelectorAll('.blocks-panel .block').forEach(block => {
            block.draggable = true;
            block.addEventListener('dragstart', dragStart);
        });

        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-toggle').textContent = currentTheme === 'light' ? '🌙 Тёмная' : '☀️ Светлая';
            localStorage.setItem('theme', currentTheme);
        }

        const savedTheme = localStorage.getItem('theme');
        if (savedTheme) {
            currentTheme = savedTheme;
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.getElementById('theme-toggle').textContent = currentTheme === 'light' ? '🌙 Тёмная' : '☀️ Светлая';
        }

        document.querySelectorAll('.input-type-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const inputBlock = this.closest('.block');
                const promptInput = inputBlock.querySelector('.block-input:nth-child(2)');
                
                if (this.checked) {
                    if (!promptInput.value.includes('"') && !promptInput.value.includes("'")) {
                        promptInput.value = `"${promptInput.value}"`;
                    }
                } else {
                    promptInput.value = promptInput.value.replace(/['"]/g, '');
                }
            });
        });

        document.getElementById('chat-send').addEventListener('click', sendChatMessage);
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendChatMessage();
        });

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const messages = document.getElementById('chat-messages');
            
            if (input.value.trim() === '') return;
            
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message user';
            userMessage.textContent = input.value;
            messages.appendChild(userMessage);
            
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
            
            setTimeout(() => {
                const botMessage = document.createElement('div');
                botMessage.className = 'chat-message';
                botMessage.textContent = 'Спасибо за ваше сообщение! Мы ответим в ближайшее время.';
                messages.appendChild(botMessage);
                messages.scrollTop = messages.scrollHeight;
            }, 1000);
        }

        function dragStart(e) {
            draggedBlock = e.target.cloneNode(true);
            draggedBlock.id = 'block-' + nextBlockId++;
            draggedBlock.style.position = 'absolute';
            draggedBlock.style.opacity = '0.8';
            
            const bottomConnector = document.createElement('div');
            bottomConnector.className = 'connector';
            draggedBlock.appendChild(bottomConnector);
            
            const topConnector = document.createElement('div');
            topConnector.className = 'connector top-connector';
            draggedBlock.appendChild(topConnector);
            
            document.body.appendChild(draggedBlock);
            e.dataTransfer.setDragImage(draggedBlock, 75, 10);
            e.dataTransfer.setData('block-type', e.target.dataset.type);
        }

        const workspace = document.getElementById('workspace');
        workspace.addEventListener('dragover', e => {
            e.preventDefault();
            if (draggedBlock) {
                draggedBlock.style.left = (e.clientX - workspace.getBoundingClientRect().left - 75) + 'px';
                draggedBlock.style.top = (e.clientY - workspace.getBoundingClientRect().top - 10) + 'px';
            }
        });

        workspace.addEventListener('drop', e => {
            e.preventDefault();
            if (draggedBlock) {
                draggedBlock.style.position = 'absolute';
                draggedBlock.style.left = (e.clientX - workspace.getBoundingClientRect().left - 75) + 'px';
                draggedBlock.style.top = (e.clientY - workspace.getBoundingClientRect().top - 10) + 'px';
                draggedBlock.style.opacity = '1';
                workspace.appendChild(draggedBlock);
                
                setupConnectors(draggedBlock);
                draggedBlock = null;
            }
        });

        function setupConnectors(block) {
            const connectors = block.querySelectorAll('.connector');
            connectors.forEach(connector => {
                connector.addEventListener('mousedown', startConnection);
            });
        }

        function startConnection(e) {
            e.stopPropagation();
            draggingConnection = {
                block: e.target.parentNode,
                connector: e.target,
                x: e.clientX,
                y: e.clientY
            };
            
            tempLine = document.createElement('div');
            tempLine.className = 'connection-line';
            workspace.appendChild(tempLine);
            
            document.addEventListener('mousemove', drawTempConnection);
            document.addEventListener('mouseup', finishConnection);
        }

        function drawTempConnection(e) {
            const start = draggingConnection.connector.getBoundingClientRect();
            const startX = start.left + start.width/2 - workspace.getBoundingClientRect().left;
            const startY = start.top + start.height/2 - workspace.getBoundingClientRect().top;
            
            const endX = e.clientX - workspace.getBoundingClientRect().left;
            const endY = e.clientY - workspace.getBoundingClientRect().top;
            
            const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
            const angle = Math.atan2(endY - startY, endX - startX);
            
            tempLine.style.left = startX + 'px';
            tempLine.style.top = startY + 'px';
            tempLine.style.width = length + 'px';
            tempLine.style.transform = `rotate(${angle}rad)`;
        }

        function finishConnection(e) {
            document.removeEventListener('mousemove', drawTempConnection);
            document.removeEventListener('mouseup', finishConnection);
            
            if (tempLine) {
                workspace.removeChild(tempLine);
                tempLine = null;
            }
            
            const target = document.elementFromPoint(e.clientX, e.clientY);
            if (target && target.classList.contains('connector') && 
                target !== draggingConnection.connector &&
                target.parentNode !== draggingConnection.block) {
                
                createConnection(
                    draggingConnection.block, 
                    draggingConnection.connector,
                    target.parentNode, 
                    target
                );
            }
            
            draggingConnection = null;
        }

        function createConnection(fromBlock, fromConnector, toBlock, toConnector) {
            const line = document.createElement('div');
            line.className = 'connection-line';
            workspace.appendChild(line);
            
            function updateLine() {
                const start = fromConnector.getBoundingClientRect();
                const end = toConnector.getBoundingClientRect();
                const workspaceRect = workspace.getBoundingClientRect();
                
                const startX = start.left + start.width/2 - workspaceRect.left;
                const startY = start.top + start.height/2 - workspaceRect.top;
                const endX = end.left + end.width/2 - workspaceRect.left;
                const endY = end.top + end.height/2 - workspaceRect.top;
                
                const length = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2));
                const angle = Math.atan2(endY - startY, endX - startX);
                
                line.style.left = startX + 'px';
                line.style.top = startY + 'px';
                line.style.width = length + 'px';
                line.style.transform = `rotate(${angle}rad)`;
            }
            
            updateLine();
            
            connections.push({
                from: fromBlock.id,
                to: toBlock.id,
                line: line,
                update: updateLine
            });
            
            const observer = new MutationObserver(updateLine);
            observer.observe(fromBlock, { attributes: true });
            observer.observe(toBlock, { attributes: true });
        }

        document.getElementById('run-btn').addEventListener('click', async () => {
            const code = generateCode();
            document.getElementById('output').textContent = "> Сгенерированный код:\n" + code + "\n\n> Результат:\n";
            
            try {
                const result = await pyodide.runPythonAsync(code);
                document.getElementById('output').textContent += result !== undefined ? result : "Код выполнен успешно";
            } catch (err) {
                document.getElementById('output').textContent += "Ошибка: " + err;
            }
        });

        document.getElementById('clear-btn').addEventListener('click', () => {
            workspace.innerHTML = '';
            connections = [];
            document.getElementById('output').textContent = "> Рабочая область очищена";
        });

        function generateCode() {
            let code = "";
            const blocks = workspace.querySelectorAll('.block');
            
            blocks.forEach(block => {
                code += getBlockCode(block) + "\n";
            });
            
            return code;
        }

        function getBlockCode(block) {
            const type = block.dataset.type;
            const inputs = block.querySelectorAll('.block-input');
            
            switch(type) {
                case 'var_decl': return `${inputs[0].value} = ${inputs[1].value}`;
                case 'var_assign': return `${inputs[0].value} = ${inputs[1].value}`;
                case 'if': return `if ${inputs[0].value}:`;
                case 'elif': return `elif ${inputs[0].value}:`;
                case 'else': return `else:`;
                case 'for': return `for ${inputs[0].value} in range(${inputs[1].value}):`;
                case 'while': return `while ${inputs[0].value}:`;
                case 'break': return `break`;
                case 'continue': return `continue`;
                case 'def': return `def ${inputs[0].value}():`;
                case 'return': return `return ${inputs[0].value}`;
                case 'lambda': return `lambda ${inputs[0].value}: ${inputs[1].value}`;
                case 'print': return `print(${inputs[0].value})`;
                case 'input': return `${inputs[0].value} = input(${inputs[1].value})`;
                case 'list': return `[${inputs[0].value}]`;
                case 'dict': return `{${inputs[0].value}}`;
                case 'tuple': return `(${inputs[0].value})`;
                case 'import': return `import ${inputs[0].value}`;
                case 'try': return `try:`;
                case 'except': return `except ${inputs[0].value}:`;
                case 'finally': return `finally:`;
                case 'with': return `with ${inputs[0].value} as ${inputs[1].value}:`;
                default: return `# Неизвестный блок: ${type}`;
            }
        }
    </script>
</body>
</html>
